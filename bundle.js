(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"],t={default:{width:"40px",height:"44px",borderRadius:"0",marginLeft:"0"},edited:{width:"70px",height:"70px",borderRadius:"5px",marginLeft:"-15px"}},o=document.querySelector(".ad-form"),n=o.querySelector("#avatar"),r=o.querySelector(".ad-form-header__preview img"),a=o.querySelector("#images"),i=o.querySelector(".ad-form__photo"),d=(t,o)=>{const n=t.name.toLowerCase();e.some((e=>n.endsWith(e)))&&o(t)},s=e=>{const o=t.edited,n=()=>{URL.revokeObjectURL(r.src),r.removeEventListener("load",n)};r.addEventListener("load",n),r.src=URL.createObjectURL(e),r.style.width=o.width,r.style.height=o.height,r.style.borderRadius=o.borderRadius,r.style.marginLeft=o.marginLeft},c=e=>{const o=document.createElement("img"),n=t.edited,r=()=>{URL.revokeObjectURL(o.src),o.removeEventListener("load",r)};o.addEventListener("load",r),o.src=URL.createObjectURL(e),i.innerHTML="",o.style.width=n.width,o.style.height=n.height,o.style.borderRadius=n.borderRadius,i.appendChild(o)},l=()=>{d(n.files[0],s)},u=()=>{d(a.files[0],c)};window.load={addForm:o,setDisabledImg:()=>{const e=t.default;r.style.width=e.width,r.style.height=e.height,r.style.borderRadius=e.borderRadius,r.style.marginLeft=e.marginLeft,r.src="img/muffin-grey.svg",i.innerHTML="",n.removeEventListener("change",l),a.removeEventListener("change",u)},setEnabledImg:()=>{n.addEventListener("change",l),a.addEventListener("change",u)}}})(),(()=>{const e=function(e,t){const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){let n;switch(o.status){case 200:e(o.response);break;case 400:break;case 404:n="страница не найдена";break;case 500:n="ошибка сервера";break;default:n="статус ответа: : "+o.status+" "+o.statusText}n&&t(n)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.timeout=5e3,o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o};window.backend={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}},(()=>{const e={ESC:"Escape",ENTER:"Enter",NUMPUD_ENTER:"NumpudEnter"};window.util={isEnterEvent:t=>t.code===e.ENTER||t.code===e.NUMPAD_ENTER,isEscapeEvent:t=>t.code===e.ESC,isMouseLeftButtonEvent:e=>0===e.button}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,o=document.querySelector(".map"),n=o.querySelector(".map__filters"),r=o.querySelector(".map__pins"),a={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},i=(e,t)=>(e=Math.abs(e)%100)>10&&e<20?t[2]:e%10>1&&e%10<5?t[1]:e%10==1?t[0]:t[2],d=e=>{e.data.every((e=>e))?e.cb():e.field.classList.add("hidden")},s=t=>{e(t)&&l()},c=e=>{t(e)&&l()},l=()=>{let e=o.querySelector(".popup");e&&e.remove(),document.removeEventListener("keydown",s)};window.data={map:o,mapFilters:n,mapPins:r,createCard:e=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),l=e.offer.rooms,u=e.offer.guests;o.insertBefore(t,r);let p=t.querySelector(".popup__title"),m=t.querySelector(".popup__text--address"),f=t.querySelector(".popup__text--price"),v=t.querySelector(".popup__text--capacity"),w=t.querySelector(".popup__text--time"),y=t.querySelector(".popup__features"),h=t.querySelector(".popup__description"),E=t.querySelector(".popup__avatar"),L=t.querySelector(".popup__type"),g=t.querySelector(".popup__photos");d({field:p,data:[e.offer.title],cb(){p.textContent=e.offer.title}}),d({field:m,data:[e.offer.address],cb(){m.innerHTML=e.offer.address}}),d({field:f,data:[e.offer.price],cb(){f.innerHTML=e.offer.price+" &#x20bd/ночь"}}),d({field:v,data:[l,l],cb(){v.textContent=`${l}${i(l,[" комната "," комнаты "," комнат "])} для ${u}${i(u,[" гостя "," гостей "," гостей "])}`}}),d({field:w,data:[e.offer.checkin,e.offer.checkout],cb(){w.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`}}),d({field:h,data:[e.offer.description],cb(){h.textContent=e.offer.description}}),d({field:E,data:[e.author.avatar],cb(){E.src=e.author.avatar}}),d({field:L,data:[e.offer.type],cb(){L.textContent=a[e.offer.type]}}),d({field:y,data:[e.offer.features],cb(){y.innerHTML="",y.appendChild((e=>{const t=document.createDocumentFragment();for(let o=0;o<e.length;o++){const n=document.createElement("li");n.classList.add("popup__feature");const r="popup__feature--"+e[o];n.classList.add(r),t.appendChild(n)}return t})(e.offer.features))}}),d({field:g,data:[e.offer.photos],cb(){g.innerHTML="",g.appendChild((e=>{const t=document.createDocumentFragment();for(let o=0;o<e.length;o++){const n=document.createElement("img");n.src=e[o],n.width=45,n.height=40,n.classList.add("popup__photo"),t.appendChild(n)}return t})(e.offer.photos))}}),n.insertBefore(t,null),t.querySelector(".popup__close").addEventListener("click",c),document.addEventListener("keydown",s)},closePopup:l}})(),(()=>{const e={WIDTH:65,HEIGHT:65,MARKER_HEIGHT:22},t=window.data.closePopup,o=window.data.createCard,n=window.data.mapPins,r=n=>{const r=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0),i=r.querySelector("img");return r.style.left=n.location.x-e.WIDTH/2+"px",r.style.top=n.location.y-(e.HEIGHT+e.MARKER_HEIGHT)+"px",i.src=n.author.avatar,i.alt=n.offer.title,r.addEventListener("click",(function(e){a("IMG"===e.target.tagName?e.target.parentElement:e.target),t(),o(n)})),r},a=e=>{let t=n.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),e.classList.add("map__pin--active")};window.pin={SIZE_PIN:e,renderPins:e=>{const t=document.createDocumentFragment();for(let o=0;o<e.length;o++)t.appendChild(r(e[o]));n.appendChild(t)},removePins:()=>{n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,o=document.querySelector("main"),n=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error"),a=r.querySelector(".error__button"),i=t=>{e(t)&&u()},d=t=>{e(t)&&p()},s=e=>{t(e)&&e.target===n&&u()},c=e=>{t(e)&&e.target===r&&p()},l=e=>{t(e)&&p()},u=()=>{n.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",c)},p=()=>{r.remove(),document.removeEventListener("keydown",d),document.removeEventListener("click",c)};window.message={onLoad:()=>{window.mapinit.deactivate(),o.appendChild(n),document.addEventListener("keydown",i),n.addEventListener("click",s)},onError:()=>{o.appendChild(r),document.addEventListener("keydown",d),r.addEventListener("click",c),a.addEventListener("click",l)}}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=window.data.mapPins,n=window.message.onLoad,r=window.message.onError,a=o.querySelector(".map__pin--main"),i=window.load.addForm,d=i.querySelector("#room_number"),s=i.querySelector("#type"),c=i.querySelector("#capacity").querySelectorAll("option"),l=i.querySelector("#timein"),u=i.querySelector("#timeout"),p=i.querySelector("#title"),m=i.querySelector("#price"),f=i.querySelector(".ad-form__submit"),v=i.querySelector(".ad-form__reset"),w=()=>{c.forEach((t=>{const o=!(e[d.value].indexOf(t.value)>=0);t.selected=e[d.value][0]===t.value,t.disabled=o,t.hidden=o}))};w(),l.addEventListener("change",(()=>{var e;e=l.value,u.value=e})),u.addEventListener("change",(()=>{var e;e=u.value,l.value=e})),d.addEventListener("change",(()=>{w()})),s.addEventListener("change",(()=>{var e;e=t[s.value],m.min=e,m.placeholder=e}));const y=e=>{m.checkValidity()&&p.checkValidity()&&window.backend.save(new FormData(i),n,r),e.preventDefault(),f.removeEventListener("submit",y)},h=e=>{e.preventDefault(),window.mapinit.deactivate(),v.removeEventListener("click",h)};i.addEventListener("submit",y),v.addEventListener("click",h),window.form={addForm:i,pinMain:a}})(),(()=>{const e=window.pin.SIZE_PIN,t=window.util.isEnterEvent,o=window.util.isMouseLeftButtonEvent,n=window.pin.renderPins,r=window.data.map,a=window.data.closePopup,i=window.load.addForm,d=window.form.pinMain,s=window.pin.removePins,c=window.backend.load,l=window.load.setDisabledImg,u=window.load.setEnabledImg,p=document.querySelector("main"),m=i.querySelector("#address"),f=document.querySelectorAll("fieldset, select"),v={x:d.style.left,y:d.style.top};let w=[];const y=()=>{let t=parseInt(d.style.left,10),o=parseInt(d.style.top,10);r.classList.contains("map--faded")?(t=""+Math.floor(t+e.WIDTH/2),o=""+Math.floor(o+e.HEIGHT/2)):(t=""+Math.floor(t+e.WIDTH/2),o=""+Math.floor(o+(e.HEIGHT+e.MARKER_HEIGHT))),m.value=`${t}, ${o}`};y();const h=()=>{f.forEach((e=>{e.disabled=!e.disabled}))};h();const E=e=>{for(let t=0;t<e.length;t++)e[t].offer&&w.push(e[t]);n(w.slice(0,5))},L=e=>{const t=document.createDocumentFragment(),o=document.createElement("div");t.appendChild(o),o.style="z-index: 1000; margin: 0 auto; text-align: center; background-color: rgba(3, 28, 45, 0.5);",o.style.position="absolute",o.style.width="100%",o.style.height="50px",o.style.left=0,o.style.right=0,o.style.fontSize="24px",o.textContent=`Не удалось загрузить данные: ${e}. Попробуйте перезагрузить страницу`,p.prepend(t)},g=()=>{r.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),y(),h(),u(),c(E,L)},_=e=>{o(e)&&(g(),d.removeEventListener("mousedown",_))},S=e=>{t(e)&&(g(),d.removeEventListener("keydown",S))};d.addEventListener("mousedown",_),d.addEventListener("keydown",S),window.mapinit={AMOUNT:5,onLoad:E,pins:()=>w,initialaze:g,deactivate:()=>{r.classList.add("map--faded"),i.classList.add("ad-form--disabled"),i.reset(),d.style.left=v.x,d.style.top=v.y,y(),h(),s(),a(),l(),d.addEventListener("mousedown",_)},getAddress:y}})(),(()=>{const e=window.mapinit.AMOUNT,t="any",o=window.data.closePopup,n=window.pin.renderPins,r=window.pin.removePins,a=document.querySelector(".map__filters"),i=a.querySelector("#housing-type"),d=a.querySelector("#housing-price"),s=a.querySelector("#housing-rooms"),c=a.querySelector("#housing-guests"),l=a.querySelector("#housing-features"),u=e=>s.value===e.offer.rooms.toString()||s.value===t,p=e=>c.value===e.offer.guests.toString()||c.value===t,m=e=>d.value===t||"low"===d.value&&e.offer.price<1e4||"middle"===d.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===d.value&&e.offer.price>5e4,f=e=>Array.from(l.querySelectorAll("input[type = checkbox]:checked")).every((t=>e.offer.features.includes(t.value))),v=window.debounce((()=>{const a=window.mapinit.pins();o(),r();let d=[];for(let o=0;o<a.length&&(s=a[o],(i.value===s.offer.type||i.value===t)&&m(a[o])&&u(a[o])&&p(a[o])&&f(a[o])&&d.push(a[o]),d.length!==e);o++);var s;n(d)}));a.addEventListener("change",v)})(),(()=>{const e=window.pin.SIZE_PIN,t=e.WIDTH/2,o=e.HEIGHT+e.MARKER_HEIGHT,n=window.util.isMouseLeftButtonEvent,r=window.mapinit.getAddress,a=window.mapinit.initialaze,i=document.querySelector(".map"),d=i.querySelector(".map__pins"),s=d.querySelector(".map__pin--main"),c=d.offsetWidth;s.addEventListener("mousedown",(function(e){e.preventDefault();let d={x:e.clientX,y:e.clientY};const l=l=>{l.preventDefault();const u={x:d.x-l.clientX,y:d.y-l.clientY};d={x:l.clientX,y:l.clientY},n(e)&&i.classList.contains(".map--faded")&&a(),(e=>{let n=s.offsetLeft-e.x,r=s.offsetTop-e.y;n<1-t?n=1:n>c-t&&(n=c-t),r<130-o?r=130-o:r>630-o&&(r=630-o),s.style.top=r+"px",s.style.left=n+"px"})(u),r()},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u)}))})()})();