(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"],t={default:{width:"40px",height:"44px",borderRadius:"0",marginLeft:"0"},edited:{width:"70px",height:"70px",borderRadius:"5px",marginLeft:"-15px"}},n=document.querySelector(".ad-form"),o=n.querySelector("#avatar"),r=n.querySelector(".ad-form-header__preview img"),a=n.querySelector("#images"),i=n.querySelector(".ad-form__photo"),d=(t,n)=>{const o=t.name.toLowerCase();e.some((e=>o.endsWith(e)))&&n(t)},s=e=>{const n=t.edited,o=()=>{URL.revokeObjectURL(r.src),r.removeEventListener("load",o)};r.addEventListener("load",o),r.src=URL.createObjectURL(e),r.style.width=n.width,r.style.height=n.height,r.style.borderRadius=n.borderRadius,r.style.marginLeft=n.marginLeft},c=e=>{const n=document.createElement("img"),o=t.edited,r=()=>{URL.revokeObjectURL(n.src),n.removeEventListener("load",r)};n.addEventListener("load",r),n.src=URL.createObjectURL(e),i.innerHTML="",n.style.width=o.width,n.style.height=o.height,n.style.borderRadius=o.borderRadius,i.appendChild(n)},l=()=>{d(o.files[0],s)},u=()=>{d(a.files[0],c)};window.load={addForm:n,setDisabledImg:()=>{const e=t.default;r.style.width=e.width,r.style.height=e.height,r.style.borderRadius=e.borderRadius,r.style.marginLeft=e.marginLeft,r.src="img/muffin-grey.svg",i.innerHTML="",o.removeEventListener("change",l),a.removeEventListener("change",u)},setEnabledImg:()=>{o.addEventListener("change",l),a.addEventListener("change",u)}}})(),(()=>{const e=function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){let o;switch(n.status){case 200:e(n.response);break;case 400:break;case 404:o="страница не найдена";break;case 500:o="ошибка сервера";break;default:o="статус ответа: : "+n.status+" "+n.statusText}o&&t(o)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.timeout=5e3,n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n};window.backend={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},save:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...n)}),500)}},(()=>{const e={ESC:"Escape",ENTER:"Enter",NUMPUD_ENTER:"NumpudEnter"};window.util={isEnterEvent:t=>t.code===e.ENTER||t.code===e.NUMPAD_ENTER,isEscapeEvent:t=>t.code===e.ESC,isMouseLeftButtonEvent:e=>0===e.button}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,n=document.querySelector(".map"),o=n.querySelector(".map__filters"),r=n.querySelector(".map__pins"),a={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},i=(e,t)=>(e=Math.abs(e)%100)>10&&e<20?t[2]:e%10>1&&e%10<5?t[1]:e%10==1?t[0]:t[2],d=t=>{e(t)&&c()},s=e=>{t(e)&&c()},c=()=>{let e=n.querySelector(".popup");e&&e.remove(),document.removeEventListener("keydown",d)};window.data={map:n,mapFilters:o,mapPins:r,createCard:e=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),c=e.offer.rooms,l=e.offer.guests;n.insertBefore(t,r),t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").innerHTML=e.offer.price+" &#x20bd/ночь",t.querySelector(".popup__type").textContent=a[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${c}${i(c,[" комната "," комнаты "," комнат "])} для ${l}${i(l,[" гостя "," гостей "," гостей "])}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin} выезд после ${e.offer.checkout}`,t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__avatar").src=e.author.avatar;const u=t.querySelector(".popup__features");u.innerHTML="",u.appendChild((e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("li");o.classList.add("popup__feature");const r="popup__feature--"+e[n];o.classList.add(r),t.appendChild(o)}return t})(e.offer.features));const p=t.querySelector(".popup__photos");p.innerHTML="",p.appendChild((e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("img");o.src=e[n],o.width=45,o.height=40,o.classList.add("popup__photo"),t.appendChild(o)}return t})(e.offer.photos)),o.insertBefore(t,null),t.querySelector(".popup__close").addEventListener("click",s),document.addEventListener("keydown",d)},closePopup:c}})(),(()=>{const e={WIDTH:65,HEIGHT:65,MARKER_HEIGHT:22},t=window.data.closePopup,n=window.data.createCard,o=window.data.mapPins,r=o=>{const r=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0),i=r.querySelector("img");return r.style.left=o.location.x-e.WIDTH/2+"px",r.style.top=o.location.y-(e.HEIGHT+e.MARKER_HEIGHT)+"px",i.src=o.author.avatar,i.alt=o.offer.title,r.addEventListener("click",(function(e){a("IMG"===e.target.tagName?e.target.parentElement:e.target),t(),n(o)})),r},a=e=>{let t=o.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),e.classList.add("map__pin--active")};window.pin={SIZE_PIN:e,renderPins:e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(r(e[n]));o.appendChild(t)},removePins:()=>{o.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,n=document.querySelector("main"),o=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error"),a=r.querySelector(".error__button"),i=t=>{e(t)&&u()},d=t=>{e(t)&&p()},s=e=>{t(e)&&e.target===o&&u()},c=e=>{t(e)&&e.target===r&&p()},l=e=>{t(e)&&p()},u=()=>{o.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",c)},p=()=>{r.remove(),document.removeEventListener("keydown",d),document.removeEventListener("click",c)};window.message={onLoad:()=>{window.mapinit.deactivate(),n.appendChild(o),document.addEventListener("keydown",i),o.addEventListener("click",s)},onError:()=>{n.appendChild(r),document.addEventListener("keydown",d),r.addEventListener("click",c),a.addEventListener("click",l)}}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},n=window.data.mapPins,o=window.message.onLoad,r=window.message.onError,a=n.querySelector(".map__pin--main"),i=window.load.addForm,d=i.querySelector("#room_number"),s=i.querySelector("#type"),c=i.querySelector("#capacity").querySelectorAll("option"),l=i.querySelector("#timein"),u=i.querySelector("#timeout"),p=i.querySelector("#title"),m=i.querySelector("#price"),v=i.querySelector(".ad-form__submit"),f=i.querySelector(".ad-form__reset"),w=()=>{c.forEach((t=>{const n=!(e[d.value].indexOf(t.value)>=0);t.selected=e[d.value][0]===t.value,t.disabled=n,t.hidden=n}))};w(),l.addEventListener("change",(()=>{var e;e=l.value,u.value=e})),u.addEventListener("change",(()=>{var e;e=u.value,l.value=e})),d.addEventListener("change",(()=>{w()})),s.addEventListener("change",(()=>{var e;e=t[s.value],m.min=e,m.placeholder=e}));const y=e=>{m.checkValidity()&&p.checkValidity()&&window.backend.save(new FormData(i),o,r),e.preventDefault(),v.removeEventListener("submit",y)},E=e=>{e.preventDefault(),window.mapinit.deactivate(),f.removeEventListener("click",E)};i.addEventListener("submit",y),f.addEventListener("click",E),window.form={addForm:i,pinMain:a}})(),(()=>{const e=window.util.isEnterEvent,t=window.util.isMouseLeftButtonEvent,n=window.pin.SIZE_PIN,o=window.pin.renderPins,r=window.data.map,a=window.data.closePopup,i=window.load.addForm,d=window.form.pinMain,s=window.pin.removePins,c=window.backend.load,l=window.load.setDisabledImg,u=window.load.setEnabledImg,p=document.querySelector("main"),m=i.querySelector("#address"),v=document.querySelectorAll("fieldset, select"),f={x:d.style.left,y:d.style.top};let w=[];const y=()=>{let e=parseInt(d.style.left,10),t=parseInt(d.style.top,10);r.classList.contains("map--faded")?(e=""+Math.floor(e+n.WIDTH/2),t=""+Math.floor(t+n.HEIGHT/2)):(e=""+Math.floor(e+n.WIDTH/2),t=""+Math.floor(t+(n.HEIGHT+n.MARKER_HEIGHT))),m.value=`${e}, ${t}`};y();const E=()=>{v.forEach((e=>{e.disabled=!e.disabled}))};E();const h=e=>{for(let t=0;t<e.length;t++)e[t].offer&&w.push(e[t]);o(w.slice(0,5))},g=e=>{const t=document.createDocumentFragment(),n=document.createElement("div");t.appendChild(n),n.style="z-index: 1000; margin: 0 auto; text-align: center; background-color: rgba(3, 28, 45, 0.5);",n.style.position="absolute",n.style.width="100%",n.style.height="50px",n.style.left=0,n.style.right=0,n.style.fontSize="24px",n.textContent=`Не удалось загрузить данные: ${e}. Попробуйте перезагрузить страницу`,p.prepend(t)},L=()=>{r.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),y(),E(),u(),c(h,g)},_=e=>{t(e)&&(L(),d.removeEventListener("mousedown",_))},S=t=>{e(t)&&(L(),d.removeEventListener("keydown",S))};d.addEventListener("mousedown",_),d.addEventListener("keydown",S),window.mapinit={AMOUNT:5,onLoad:h,pins:()=>w,initialaze:L,deactivate:()=>{r.classList.add("map--faded"),i.classList.add("ad-form--disabled"),i.reset(),d.style.left=f.x,d.style.top=f.y,y(),E(),s(),a(),l(),d.addEventListener("mousedown",_)},getAddress:y}})(),(()=>{const e=window.mapinit.AMOUNT,t="any",n=window.data.closePopup,o=window.pin.renderPins,r=window.pin.removePins,a=document.querySelector(".map__filters"),i=a.querySelector("#housing-type"),d=a.querySelector("#housing-price"),s=a.querySelector("#housing-rooms"),c=a.querySelector("#housing-guests"),l=a.querySelector("#housing-features"),u=e=>s.value===e.offer.rooms.toString()||s.value===t,p=e=>c.value===e.offer.guests.toString()||c.value===t,m=e=>d.value===t||"low"===d.value&&e.offer.price<1e4||"middle"===d.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===d.value&&e.offer.price>5e4,v=e=>Array.from(l.querySelectorAll("input[type = checkbox]:checked")).every((t=>e.offer.features.includes(t.value))),f=window.debounce((()=>{const a=window.mapinit.pins();n(),r();let d=[];for(let n=0;n<a.length&&(s=a[n],(i.value===s.offer.type||i.value===t)&&m(a[n])&&u(a[n])&&p(a[n])&&v(a[n])&&d.push(a[n]),d.length!==e);n++);var s;o(d)}));a.addEventListener("change",f)})(),(()=>{const e=window.pin.SIZE_PIN,t=e.WIDTH/2,n=e.HEIGHT+e.MARKER_HEIGHT,o=window.util.isMouseLeftButtonEvent,r=window.mapinit.getAddress,a=window.mapinit.initialaze,i=document.querySelector(".map"),d=i.querySelector(".map__pins"),s=d.querySelector(".map__pin--main"),c=d.offsetWidth;s.addEventListener("mousedown",(function(e){e.preventDefault();let d={x:e.clientX,y:e.clientY};const l=l=>{l.preventDefault();const u={x:d.x-l.clientX,y:d.y-l.clientY};d={x:l.clientX,y:l.clientY},o(e)&&i.classList.contains(".map--faded")&&a(),(e=>{let o=s.offsetLeft-e.x,r=s.offsetTop-e.y;o<1-t?o=1:o>c-t&&(o=c-t),r<130-n?r=130-n:r>630-n&&(r=630-n),s.style.top=r+"px",s.style.left=o+"px"})(u),r()},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u)}))})()})();