(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"],t={default:{width:"40px",height:"44px",borderRadius:"0",marginLeft:"0"},edited:{width:"70px",height:"70px",borderRadius:"5px",marginLeft:"-15px"}},o=document.querySelector(".ad-form"),n=o.querySelector("#avatar"),r=o.querySelector(".ad-form-header__preview img"),a=o.querySelector("#images"),i=o.querySelector(".ad-form__photo"),s=(t,o)=>{const n=t.name.toLowerCase();e.some((e=>n.endsWith(e)))&&o(t)},d=e=>{const o=t.edited,n=()=>{URL.revokeObjectURL(r.src),r.removeEventListener("load",n)};r.addEventListener("load",n),r.src=URL.createObjectURL(e),r.style.width=o.width,r.style.height=o.height,r.style.borderRadius=o.borderRadius,r.style.marginLeft=o.marginLeft},c=e=>{const o=document.createElement("img"),n=t.edited,r=()=>{URL.revokeObjectURL(o.src),o.removeEventListener("load",r)};o.addEventListener("load",r),o.src=URL.createObjectURL(e),i.textContent="",o.style.width=n.width,o.style.height=n.height,o.style.borderRadius=n.borderRadius,i.appendChild(o)},l=()=>{s(n.files[0],d)},u=()=>{s(a.files[0],c)};window.load={addForm:o,setDisabledImg:()=>{const e=t.default;r.style.width=e.width,r.style.height=e.height,r.style.borderRadius=e.borderRadius,r.style.marginLeft=e.marginLeft,r.src="img/muffin-grey.svg",i.textContent="",n.removeEventListener("change",l),a.removeEventListener("change",u)},setEnabledImg:()=>{n.addEventListener("change",l),a.addEventListener("change",u)}}})(),(()=>{const e=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let n;switch(o.status){case 200:e(o.response);break;case 400:break;case 404:n="страница не найдена";break;case 500:n="ошибка сервера";break;default:n="статус ответа: : "+o.status+" "+o.statusText}n&&t(n)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.timeout=5e3,o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o};window.backend={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}},window.util={isEnterEvent:e=>"Enter"===e.code||"NumpadEnter"===e.code,isEscapeEvent:e=>"Escape"===e.code,isMouseLeftButtonEvent:e=>0===e.button},(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,o=document.querySelector(".map"),n=o.querySelector(".map__filters"),r=o.querySelector(".map__pins"),a=document.querySelector("#card").content.querySelector(".map__card"),i={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},s=(e,t)=>(e=Math.abs(e)%100)>10&&e<20?t[2]:e%10>1&&e%10<5?t[1]:e%10==1?t[0]:t[2],d=e=>{e.classList.add("hidden")},c=t=>{e(t)&&u()},l=e=>{t(e)&&u()},u=()=>{const e=o.querySelector(".popup");e&&e.remove(),r.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")})),document.removeEventListener("keydown",c)};window.card={map:o,mapFilters:n,mapPins:r,create:e=>{const t=a.cloneNode(!0),u=e.offer.rooms,p=e.offer.guests,m=t.querySelector(".popup__title"),f=t.querySelector(".popup__text--address"),v=t.querySelector(".popup__text--price"),w=t.querySelector(".popup__text--capacity"),y=t.querySelector(".popup__text--time"),h=t.querySelector(".popup__features"),E=t.querySelector(".popup__description"),g=t.querySelector(".popup__avatar"),L=t.querySelector(".popup__type"),_=t.querySelector(".popup__photos");e.offer.title?m.textContent=e.offer.title:d(m),e.offer.price?v.textContent=e.offer.price+" ₽/ночь":d(v),e.offer.address?f.textContent=e.offer.address:d(f),e.offer.type?L.textContent=i[e.offer.type]:d(L),e.offer.rooms||e.offer.guests?w.textContent=`${u}${s(u,[" комната "," комнаты "," комнат "])} для ${p}${s(p,[" гостя "," гостей "," гостей "])}`:d(w),e.offer.checkin||e.offer.checkout?y.textContent=`Заезд после ${e.offer.checkin} выезд после ${e.offer.checkout}`:d(y),e.offer.description?E.textContent=e.offer.description:d(E),e.author.avatar?g.src=e.author.avatar:d(g),e.offer.features?(h.textContent="",h.appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("li");o.classList.add("popup__feature");const n="popup__feature--"+e;o.classList.add(n),t.appendChild(o)})),t})(e.offer.features))):d(h),e.offer.photos?(_.textContent="",_.appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("img");o.src=e,o.width=45,o.height=40,o.classList.add("popup__photo"),t.appendChild(o)})),t})(e.offer.photos))):d(_),o.insertBefore(t,r),n.insertBefore(t,null),t.querySelector(".popup__close").addEventListener("click",l),document.addEventListener("keydown",c)},closePopup:u}})(),(()=>{const e={WIDTH:65,HEIGHT:65,MARKER_HEIGHT:10},t=window.card.closePopup,o=window.card.create,n=window.card.mapPins,r=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={SIZE_PIN:e,renderPins:a=>{const i=document.createDocumentFragment();a.forEach((a=>{i.appendChild((a=>{const i=r.cloneNode(!0),s=i.querySelector("img");return i.style.left=a.location.x-e.WIDTH/2+"px",i.style.top=a.location.y-(e.HEIGHT+e.MARKER_HEIGHT)+"px",s.src=a.author.avatar,s.alt=a.offer.title,i.addEventListener("click",(e=>{(e=>{let t=n.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),e.classList.add("map__pin--active")})("IMG"===e.target.tagName?e.target.parentElement:e.target),t(),o(a)})),i})(a))})),n.appendChild(i)},removePins:()=>{n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,o=document.querySelector("main"),n=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error"),a=r.querySelector(".error__button"),i=t=>{e(t)&&u()},s=t=>{e(t)&&p()},d=e=>{t(e)&&e.target===n&&u()},c=e=>{t(e)&&e.target===r&&p()},l=e=>{t(e)&&p()},u=()=>{n.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",c)},p=()=>{r.remove(),document.removeEventListener("keydown",s),document.removeEventListener("click",c)};window.message={onLoad:()=>{window.mapinit.setPageDeactivateState(),o.appendChild(n),document.addEventListener("keydown",i),n.addEventListener("click",d)},onError:()=>{o.appendChild(r),document.addEventListener("keydown",s),r.addEventListener("click",c),a.addEventListener("click",l)}}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=window.card.mapPins,n=window.message.onLoad,r=window.message.onError,a=o.querySelector(".map__pin--main"),i=window.load.addForm,s=i.querySelector("#room_number"),d=i.querySelector("#type"),c=i.querySelector("#capacity").querySelectorAll("option"),l=i.querySelector("#timein"),u=i.querySelector("#timeout"),p=i.querySelector("#title"),m=i.querySelector("#price"),f=i.querySelector(".ad-form__submit"),v=i.querySelector(".ad-form__reset"),w=()=>{c.forEach((t=>{const o=!(e[s.value].indexOf(t.value)>=0);t.selected=e[s.value][0]===t.value,t.disabled=o,t.hidden=o}))};w(),l.addEventListener("change",(()=>{var e;e=l.value,u.value=e})),u.addEventListener("change",(()=>{var e;e=u.value,l.value=e})),s.addEventListener("change",(()=>{w()})),d.addEventListener("change",(()=>{var e;e=t[d.value],m.min=e,m.placeholder=e}));const y=e=>{m.checkValidity()&&p.checkValidity()&&window.backend.save(new FormData(i),n,r),e.preventDefault(),f.removeEventListener("submit",y)};i.addEventListener("submit",y),v.addEventListener("click",(e=>{e.preventDefault(),window.mapinit.setPageDeactivateState()})),window.form={pinMain:a}})(),(()=>{const e=window.pin.SIZE_PIN,t=window.util.isEnterEvent,o=window.util.isMouseLeftButtonEvent,n=window.pin.renderPins,r=window.card.map,a=window.card.closePopup,i=window.load.addForm,s=window.form.pinMain,d=window.pin.removePins,c=window.backend.load,l=window.load.setDisabledImg,u=window.load.setEnabledImg,p=window.card.mapFilters,m=document.querySelector("main"),f=i.querySelector("#address"),v=document.querySelectorAll("fieldset, select"),w={x:s.style.left,y:s.style.top};let y=[];const h=()=>{let t=parseInt(s.style.left,10),o=parseInt(s.style.top,10);r.classList.contains("map--faded")?(t=""+Math.floor(t+e.WIDTH/2),o=""+Math.floor(o+e.HEIGHT/2)):(t=""+Math.floor(t+e.WIDTH/2),o=""+Math.floor(o+(e.HEIGHT+e.MARKER_HEIGHT))),f.value=`${t}, ${o}`};h();const E=()=>{v.forEach((e=>{e.disabled=!e.disabled}))};E();const g=e=>{e.forEach((e=>e.offer&&y.push(e))),n(y.slice(0,5))},L=e=>{const t=document.createDocumentFragment(),o=document.createElement("div");t.appendChild(o),o.style="z-index: 1000; margin: 0 auto; text-align: center; background-color: rgba(3, 28, 45, 0.5);",o.style.position="absolute",o.style.width="100%",o.style.height="50px",o.style.left=0,o.style.right=0,o.style.fontSize="24px",o.textContent=`Не удалось загрузить данные: ${e}. Попробуйте перезагрузить страницу`,m.prepend(t)},_=()=>{r.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),h(),E(),u(),c(g,L)},S=e=>{o(e)&&(_(),s.removeEventListener("mousedown",S))},q=e=>{t(e)&&(_(),s.removeEventListener("keydown",q))};s.addEventListener("mousedown",S),s.addEventListener("keydown",q),window.mapinit={AMOUNT:5,onLoad:g,pins:()=>y,setPageInitializationState:_,setPageDeactivateState:()=>{r.classList.add("map--faded"),i.classList.add("ad-form--disabled"),p.reset(),i.reset(),s.style.left=w.x,s.style.top=w.y,h(),E(),d(),a(),l(),s.addEventListener("mousedown",S)},getAddress:h}})(),(()=>{const e=window.mapinit.AMOUNT,t="any",o=window.card.closePopup,n=window.pin.renderPins,r=window.pin.removePins,a=window.card.mapFilters,i=a.querySelector("#housing-type"),s=a.querySelector("#housing-price"),d=a.querySelector("#housing-rooms"),c=a.querySelector("#housing-guests"),l=a.querySelector("#housing-features"),u=e=>d.value===e.offer.rooms.toString()||d.value===t,p=e=>c.value===e.offer.guests.toString()||c.value===t,m=e=>s.value===t||"low"===s.value&&e.offer.price<1e4||"middle"===s.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===s.value&&e.offer.price>5e4,f=e=>Array.from(l.querySelectorAll("input[type = checkbox]:checked")).every((t=>e.offer.features.includes(t.value))),v=window.debounce((()=>{const a=window.mapinit.pins();o(),r();let s=[];for(let o=0;o<a.length&&(d=a[o],(i.value===d.offer.type||i.value===t)&&m(a[o])&&u(a[o])&&p(a[o])&&f(a[o])&&s.push(a[o]),s.length!==e);o++);var d;n(s)}));a.addEventListener("change",v)})(),(()=>{const e=window.pin.SIZE_PIN,t=e.WIDTH/2,o=e.HEIGHT+e.MARKER_HEIGHT,n=window.util.isMouseLeftButtonEvent,r=window.mapinit.getAddress,a=window.mapinit.setPageInitializationState,i=window.card.map,s=window.card.mapPins,d=window.form.pinMain,c=s.offsetWidth;d.addEventListener("mousedown",(e=>{e.preventDefault();let s={x:e.clientX,y:e.clientY};const l=l=>{l.preventDefault();const u={x:s.x-l.clientX,y:s.y-l.clientY};s={x:l.clientX,y:l.clientY},n(e)&&i.classList.contains(".map--faded")&&a(),(e=>{let n=d.offsetLeft-e.x,r=d.offsetTop-e.y;n<0-t?n=0-t:n>c-t&&(n=c-t),r<130-o?r=130-o:r>630-o&&(r=630-o),d.style.top=r+"px",d.style.left=n+"px"})(u),r()},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u)}))})()})();