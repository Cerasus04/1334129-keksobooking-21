(()=>{"use strict";(()=>{const e=function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){let o;switch(n.status){case 200:e(n.response);break;case 400:break;case 404:o="страница не найдена";break;case 500:o="ошибка сервера";break;default:o="статус ответа: : "+n.status+" "+n.statusText}o&&t(o)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.timeout=1e3,n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n};window.backend={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},save:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...n)}),500)}},(()=>{const e={ESC:"Escape",ENTER:"Enter",NUMPUD_ENTER:"NumpudEnter"};window.util={isEnterEvent:t=>t.code===e.ENTER||t.code===e.NUMPAD_ENTER,isEscapeEvent:t=>t.code===e.ESC,isMouseLeftButtonEvent:e=>0===e.button}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,n=document.querySelector(".map"),o=n.querySelector(".map__filters"),r=n.querySelector(".map__pins"),a={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},i=(e,t)=>(e=Math.abs(e)%100)>10&&e<20?t[2]:e%10>1&&e%10<5?t[1]:e%10==1?t[0]:t[2],s=t=>{e(t)&&d()},c=e=>{t(e)&&d()},d=()=>{let e=n.querySelector(".popup");e&&e.remove(),document.removeEventListener("keydown",s)};window.data={map:n,mapFilters:o,mapPins:r,createCard:e=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),d=e.offer.rooms,l=e.offer.guests;n.insertBefore(t,r),t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").innerHTML=e.offer.price+" &#x20bd/ночь",t.querySelector(".popup__type").textContent=a[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${d}${i(d,[" комната "," комнаты "," комнат "])} для ${l}${i(l,[" гостя "," гостей "," гостей "])}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin} выезд после ${e.offer.checkout}`,t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__avatar").src=e.author.avatar;const u=t.querySelector(".popup__features");u.innerHTML="",u.appendChild((e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("li");o.classList.add("popup__feature");const r="popup__feature--"+e[n];o.classList.add(r),t.appendChild(o)}return t})(e.offer.features));const p=t.querySelector(".popup__photos");p.innerHTML="",p.appendChild((e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++){const o=document.createElement("img");o.src=e[n],o.width=45,o.height=40,o.classList.add("popup__photo"),t.appendChild(o)}return t})(e.offer.photos)),o.insertBefore(t,null),t.querySelector(".popup__close").addEventListener("click",c),document.addEventListener("keydown",s)},closePopup:d}})(),(()=>{const e=window.data.closePopup,t=window.data.createCard,n=window.data.mapPins,o={WIDTH:65,HEIGHT:65,MARKER_HEIGHT:22},r=n=>{const r=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0),i=r.querySelector("img");return r.style.left=n.location.x-o.WIDTH/2+"px",r.style.top=n.location.y-(o.HEIGHT+o.MARKER_HEIGHT)+"px",i.src=n.author.avatar,i.alt=n.offer.title,r.addEventListener("click",(function(o){a("IMG"===o.target.tagName?o.target.parentElement:o.target),e(),t(n)})),r},a=e=>{let t=n.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),e.classList.add("map__pin--active")};window.pin={SIZE_PIN:o,renderPins:e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(r(e[n]));n.appendChild(t)},removePins:()=>{n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=window.util.isEscapeEvent,t=window.util.isMouseLeftButtonEvent,n=document.querySelector("main"),o=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error"),a=r.querySelector(".error__button"),i=t=>{e(t)&&u()},s=t=>{e(t)&&p()},c=e=>{t(e)&&e.target===o&&u()},d=e=>{t(e)&&e.target===r&&p()},l=e=>{t(e)&&p()},u=()=>{o.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",d)},p=()=>{r.remove(),document.removeEventListener("keydown",s),document.removeEventListener("click",d)};window.message={onLoad:()=>{window.mapinit.deactivate(),n.appendChild(o),document.addEventListener("keydown",i),o.addEventListener("click",c)},onError:()=>{n.appendChild(r),document.addEventListener("keydown",s),r.addEventListener("click",d),a.addEventListener("click",l)}}})(),(()=>{const e=window.data.mapPins,t=window.message.onLoad,n=window.message.onError,o=e.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),a=r.querySelector("#room_number"),i=r.querySelector("#type"),s=r.querySelector("#capacity").querySelectorAll("option"),c=r.querySelector("#timein"),d=r.querySelector("#timeout"),l=r.querySelector("#title"),u=r.querySelector("#price"),p=r.querySelector(".ad-form__submit"),m=r.querySelector(".ad-form__reset"),v={bungalow:0,flat:1e3,house:5e3,palace:1e4},f={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},w=()=>{s.forEach((e=>{const t=!(f[a.value].indexOf(e.value)>=0);e.selected=f[a.value][0]===e.value,e.disabled=t,e.hidden=t}))};w(),c.addEventListener("change",(()=>{var e;e=c.value,d.value=e})),d.addEventListener("change",(()=>{var e;e=d.value,c.value=e})),a.addEventListener("change",(()=>{w()})),i.addEventListener("change",(()=>{var e;e=v[i.value],u.min=e,u.placeholder=e}));const y=e=>{u.checkValidity()&&l.checkValidity()&&window.backend.save(new FormData(r),t,n),e.preventDefault(),p.removeEventListener("submit",y)},E=e=>{e.preventDefault(),window.mapinit.deactivate(),m.removeEventListener("click",E)};r.addEventListener("submit",y),m.addEventListener("click",E),window.form={addForm:r,pinMain:o}})(),(()=>{const e=window.util.isEnterEvent,t=window.util.isMouseLeftButtonEvent,n=window.pin.SIZE_PIN,o=window.pin.renderPins,r=window.data.map,a=window.data.closePopup,i=window.form.addForm,s=window.form.pinMain,c=window.pin.removePins,d=window.backend.load,l=document.querySelector("main"),u=i.querySelector("#address"),p=document.querySelectorAll("fieldset, select"),m={x:s.style.left,y:s.style.top};let v=[];const f=()=>{let e=parseInt(s.style.left,10),t=parseInt(s.style.top,10);r.classList.contains("map--faded")?(e=""+Math.floor(e+n.WIDTH/2),t=""+Math.floor(t+n.HEIGHT/2)):(e=""+Math.floor(e+n.WIDTH/2),t=""+Math.floor(t+(n.HEIGHT+n.MARKER_HEIGHT))),u.value=`${e}, ${t}`};f();const w=()=>{p.forEach((e=>{e.disabled=!e.disabled}))};w();const y=e=>{for(let t=0;t<e.length;t++)e[t].offer&&v.push(e[t]);o(v.slice(0,5))},E=e=>{const t=document.createDocumentFragment(),n=document.createElement("div");t.appendChild(n),n.style="z-index: 1000; margin: 0 auto; text-align: center; background-color: rgba(3, 28, 45, 0.5);",n.style.position="absolute",n.style.width="100%",n.style.height="50px",n.style.left=0,n.style.right=0,n.style.fontSize="24px",n.textContent=`Не удалось загрузить данные: ${e}. Попробуйте перезагрузить страницу`,l.prepend(t)},_=()=>{r.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),f(),w(),d(y,E)},h=e=>{t(e)&&(_(),s.removeEventListener("mousedown",h))},S=t=>{e(t)&&(_(),s.removeEventListener("keydown",S))};s.addEventListener("mousedown",h),s.addEventListener("keydown",S),window.mapinit={AMOUNT:5,onLoad:y,pins:()=>v,initialaze:_,deactivate:()=>{r.classList.add("map--faded"),i.classList.add("ad-form--disabled"),i.reset(),s.style.left=m.x,s.style.top=m.y,f(),w(),c(),a(),s.addEventListener("mousedown",h)},getAddress:f}})(),(()=>{const e=window.mapinit.AMOUNT,t="any",n=document.querySelector(".map__filters"),o=n.querySelector("#housing-type"),r=n.querySelector("#housing-price"),a=n.querySelector("#housing-rooms"),i=n.querySelector("#housing-guests"),s=n.querySelector("#housing-features"),c=window.data.closePopup,d=window.pin.renderPins,l=window.pin.removePins,u=e=>a.value===e.offer.rooms.toString()||a.value===t,p=e=>i.value===e.offer.guests.toString()||i.value===t,m=e=>r.value===t||"low"===r.value&&e.offer.price<1e4||"middle"===r.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===r.value&&e.offer.price>5e4,v=e=>Array.from(s.querySelectorAll("input[type = checkbox]:checked")).every((t=>e.offer.features.includes(t.value))),f=window.debounce((()=>{const n=window.mapinit.pins();c(),l();let r=[];for(let i=0;i<n.length&&(a=n[i],(o.value===a.offer.type||o.value===t)&&m(n[i])&&u(n[i])&&p(n[i])&&v(n[i])&&r.push(n[i]),r.length!==e);i++);var a;d(r)}));n.addEventListener("change",f)})(),(()=>{const e=window.pin.SIZE_PIN,t=e.WIDTH/2,n=e.HEIGHT+e.MARKER_HEIGHT,o=window.util.isMouseLeftButtonEvent,r=window.mapinit.getAddress,a=window.mapinit.initialaze,i=document.querySelector(".map"),s=i.querySelector(".map__pins"),c=s.querySelector(".map__pin--main"),d=s.offsetWidth;c.addEventListener("mousedown",(function(e){e.preventDefault();let s={x:e.clientX,y:e.clientY};const l=l=>{l.preventDefault();const u={x:s.x-l.clientX,y:s.y-l.clientY};s={x:l.clientX,y:l.clientY},o(e)&&i.classList.contains(".map--faded")&&a(),(e=>{let o=c.offsetLeft-e.x,r=c.offsetTop-e.y;o<1-t?o=1:o>d-t&&(o=d-t),r<130-n?r=130-n:r>630-n&&(r=630-n),c.style.top=r+"px",c.style.left=o+"px"})(u),r()},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u)}))})()})();